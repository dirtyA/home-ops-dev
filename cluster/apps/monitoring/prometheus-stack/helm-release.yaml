apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: 43.2.1
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
  install:
    remediation:
      retries: 5
    crds: Create
  upgrade:
    remediation:
      retries: 5
    crds: CreateReplace
  # https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/values.yaml
  values:
    defaultRules:
      create: true
      rules:
        alertmanager: true
        etcd: true
        configReloaders: true
        general: true

    alertmanager:
      enabled: true
      config:
        global:
          resolve_timeout: 5m

            #      ingress:
            #        enabled: true
            #        ingressClassName: "traefik"
            #        annotations:
            #          hajimari.io/enable: "true"
            #          hajimari.io/icon: "alpha-p-box"
            #          hajimari.io/appName: "Prometheus Operator"
            #          cert-manager.io/cluster-issuer: "letsencrypt-production"
            #          traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
            #          traefik.ingress.kubernetes.io/router.middlewares: networking-chain-no-auth@kubernetescrd
            #        hosts:
            #          - &alertUri "alerts.${SECRET_DEV_DOMAIN}"
            #        path: /
            #        pathType: prefix
            #        tls:
            #          - hosts:
            #              - *alertUri
            #            secretName: *alertUri

      alertmanagerSpec:
        storage:
          volumeClaimTemplate:
            spec:
              storageClassName: gluster
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 5Gi

    grafana:
      enabled: false
      sidecar:
        dashboards:
          enabled: true
          label: grafana_dashboard
          labelValue: "1"

          ## Annotations for Grafana dashboard configmaps
          ##
          annotations: {}
          multicluster:
            global:
              enabled: false
            etcd:
              enabled: false
          provider:
            allowUiUpdates: false
        datasources:
          enabled: true
          defaultDatasourceEnabled: true
          isDefaultDatasource: true

          uid: prometheus

    prometheusOperator:
      enabled: true
      tls:
        enabled: false
      prometheusConfigReloader:
        resources:
          limits:
            cpu: 200m
      admissionWebhooks:
        enabled: true


    prometheus:
      enabled: true
      thanosService:
        enabled: false
      thanosServiceMonitor:
        enabled: false
      prometheusSpec:
        replicas: 1
        shards: 1
        retention: 15d
        podMonitorSelector:
          matchLabels:
            app.kubernetes.io/component: monitoring

              #      ingress:
              #        enabled: true
              #        ingressClassName: "traefik"
              #        annotations:
              #          hajimari.io/enable: "true"
              #          hajimari.io/icon: "alpha-p-box"
              #          hajimari.io/appName: "Prometheus"
              #          cert-manager.io/cluster-issuer: "letsencrypt-production"
              #          traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
              #          traefik.ingress.kubernetes.io/router.middlewares: networking-chain-no-auth@kubernetescrd
              #        hosts:
              #          - &promUri "prom.${SECRET_DEV_DOMAIN}"
              #        paths: /
              #        tls:
              #          - hosts:
              #              - *promUri
              #            secretName: *promUri
